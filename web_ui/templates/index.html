<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noise Protocol Secure Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse bg-dark text-white p-0">
                <div class="sidebar-header p-3">
                    <h3 class="text-center">Noise Chat</h3>
                    <p class="text-center small">Secure Communication</p>
                </div>
                
                <div class="connection-form p-3">
                    <div id="connection-panel" class="mb-3">
                        <h5>Connection</h5>
                        <form id="connect-form">
                            <div class="mb-2">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control form-control-sm" id="username" placeholder="Your username">
                            </div>
                            <div class="mb-2">
                                <label for="server" class="form-label">Server</label>
                                <input type="text" class="form-control form-control-sm" id="server" placeholder="Enter server IP or hostname">
                            </div>
                            <div class="mb-2">
                                <label for="port" class="form-label">Port</label>
                                <input type="number" class="form-control form-control-sm" id="port" value="8000">
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100">Connect</button>
                        </form>
                    </div>
                    
                    <div id="status-panel" class="mb-3 d-none">
                        <h5>Connection Status</h5>
                        <div class="card bg-dark text-white border-secondary">
                            <div class="card-body p-2">
                                <p class="mb-1"><strong>Username:</strong> <span id="status-username">-</span></p>
                                <p class="mb-1"><strong>Server:</strong> <span id="status-server">-</span></p>
                                <p class="mb-1"><strong>Status:</strong> <span id="status-connection" class="badge bg-success">Connected</span></p>
                                <button id="disconnect-btn" class="btn btn-danger btn-sm w-100 mt-2">Disconnect</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-features p-3">
                    <h5>Features</h5>
                    <div class="list-group list-group-flush bg-dark">
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary" id="group-chat-btn">
                            <i class="bi bi-people-fill me-2"></i> Group Chat
                        </a>
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary" id="file-transfer-btn">
                            <i class="bi bi-file-earmark-arrow-up me-2"></i> File Transfer
                        </a>
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary" id="security-report-btn">
                            <i class="bi bi-shield-lock me-2"></i> Security Report
                        </a>
                        <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary" id="performance-stats-btn">
                            <i class="bi bi-graph-up me-2"></i> Performance Stats
                        </a>
                    </div>
                </div>
                
                <div class="sidebar-footer p-3 mt-auto">
                    <p class="text-center small mb-0">Noise Protocol Implementation</p>
                </div>
            </div>
            
            <!-- Main content -->
            <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Security banner -->
                <div class="row mt-3">
                    <div class="col">
                        <div class="alert alert-success d-flex align-items-center encryption-banner">
                            <i class="bi bi-shield-lock-fill me-2 fs-4"></i>
                            <div>
                                Messages are secured with Noise Protocol (XX pattern) using ChaCha20-Poly1305 encryption
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Connection error alert -->
                <div id="connection-alert" class="alert alert-danger d-none mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span id="connection-alert-message">Connection error</span>
                </div>
                
                <!-- Chat interface -->
                <div class="row mt-3">
                    <div class="col">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Secure Chat</h5>
                                    <span id="chat-status" class="badge bg-success">
                                        <i class="bi bi-shield-check me-1"></i> Encrypted
                                    </span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <!-- Room Management Section -->
                                <div class="room-header d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <div>
                                        <span class="fw-bold">Current Room:</span>
                                        <span id="active-room">Main Room</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#roomListModal">
                                            <i class="bi bi-people-fill"></i> Rooms
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#createRoomModal">
                                            <i class="bi bi-plus-circle"></i> Create
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="chat-messages" class="chat-messages p-3">
                                    <div class="text-center text-muted my-5">
                                        <i class="bi bi-chat-text fs-1"></i>
                                        <p>Connect to a server to start chatting</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <form id="message-form">
                                    <div class="input-group">
                                        <input type="text" id="message-input" class="form-control" placeholder="Type your message..." disabled>
                                        <button id="send-btn" class="btn btn-primary" type="submit" disabled>
                                            <i class="bi bi-send me-1"></i> Send
                                        </button>
                                        <button id="file-btn" class="btn btn-secondary" type="button" disabled>
                                            <i class="bi bi-paperclip"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Technical details card -->
                <div class="card mt-3" id="technical-details">
                    <div class="card-header bg-dark text-white">
                        Technical Details
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6" id="protocol-details">
                                <!-- Protocol details will be inserted here by JavaScript -->
                            </div>
                            <div class="col-md-6" id="security-properties">
                                <!-- Security properties will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- File upload modal -->
    <div class="modal fade" id="fileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Encrypted File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="file-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Select File</label>
                            <input class="form-control" type="file" id="fileInput" name="file">
                            <small class="text-muted">Maximum size: 50MB</small>
                            <div class="mt-2">
                                <small class="text-muted">Allowed file types: .txt, .pdf, .png, .jpg, .jpeg, .gif, .doc, .docx, .xls, .xlsx, .mp4, .mp3, .zip, .rar, .7z</small>
                            </div>
                        </div>
                        <input type="hidden" id="fileUploadRoomId" name="room_id" value="main">
                        <div class="progress mt-3">
                            <div id="fileUploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                style="width: 0%"></div>
                        </div>
                        <div id="uploadStatusMessage" class="mt-2 small text-muted">
                            Select a file and click "Send File" to upload.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="upload-file-btn">Send File</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Room List Modal -->
    <div class="modal fade" id="roomListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chat Rooms</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="room-list">
                        <!-- Room list will be populated here -->
                        <div class="text-center text-muted my-3">
                            <i class="bi bi-arrow-repeat"></i> Loading rooms...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="refresh-rooms-btn">Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal fade" id="createRoomModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-room-form">
                        <div class="mb-3">
                            <label for="new-room-id" class="form-label">Room ID</label>
                            <input type="text" class="form-control" id="new-room-id" placeholder="Unique identifier for the room">
                        </div>
                        <div class="mb-3">
                            <label for="new-room-name" class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="new-room-name" placeholder="Display name for the room">
                        </div>
                        <div class="mb-3">
                            <label for="new-room-description" class="form-label">Description (optional)</label>
                            <textarea class="form-control" id="new-room-description" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-room-btn">Create Room</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- Security Report Modal -->
    <div class="modal fade" id="securityReportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>Security Analysis Report
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="securityReport">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">Running security tests...</p>
                            <div class="progress mt-3">
                                <div id="securityTestProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="runSecurityTestsBtn">
                        <i class="bi bi-play-fill"></i> Run Tests Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Stats Modal -->
    <div class="modal fade" id="performanceStatsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-graph-up me-2"></i>Performance Comparison
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="messageCount" class="form-label">Message Count:</label>
                                <input type="number" class="form-control" id="messageCount" value="1000" min="100" max="10000">
                                <small class="text-muted">Number of messages to send (100-10000)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="messageSize" class="form-label">Message Size (bytes):</label>
                                <input type="number" class="form-control" id="messageSize" value="1024" min="16" max="65536">
                                <small class="text-muted">Size of each message (16-65536 bytes)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="protocolSelection" class="form-label">Protocols to Test:</label>
                                <select class="form-select" id="protocolSelection" multiple size="4">
                                    <option value="noise" selected>Noise Protocol</option>
                                    <option value="tls13" selected>TLS 1.3</option>
                                    <option value="plain_tls">TLS 1.2</option>
                                    <option value="unencrypted">Unencrypted (baseline)</option>
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd key to select multiple protocols</small>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Performance Test Configuration
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Metrics:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="metricHandshake" checked>
                                            <label class="form-check-label" for="metricHandshake">Handshake Time</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="metricLatency" checked>
                                            <label class="form-check-label" for="metricLatency">Message Latency</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="metricThroughput" checked>
                                            <label class="form-check-label" for="metricThroughput">Throughput</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="metricResource" checked>
                                            <label class="form-check-label" for="metricResource">Resource Usage</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Output Format:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="outputFormat" id="outputFormatTable" value="table" checked>
                                            <label class="form-check-label" for="outputFormatTable">Table</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="outputFormat" id="outputFormatChart" value="chart">
                                            <label class="form-check-label" for="outputFormatChart">Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="outputFormat" id="outputFormatJson" value="json">
                                            <label class="form-check-label" for="outputFormatJson">JSON</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" id="runPerformanceTestBtn">
                                    <i class="bi bi-play-fill me-1"></i>Run Performance Test
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="performanceResults">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>Configure and run a performance test to see results.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="downloadResultsBtn" disabled>
                        <i class="bi bi-download me-1"></i>Download Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Chat Overview Modal -->
    <div class="modal fade" id="groupChatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-people-fill me-2"></i>Group Chat Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="groupChatTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms-tab-pane" type="button" role="tab" aria-controls="rooms-tab-pane" aria-selected="true">
                                <i class="bi bi-chat-square-text me-1"></i>Available Rooms
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="false">
                                <i class="bi bi-plus-circle me-1"></i>Create Room
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-tab-pane" type="button" role="tab" aria-controls="active-tab-pane" aria-selected="false">
                                <i class="bi bi-people me-1"></i>Current Room
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="groupChatTabContent">
                        <div class="tab-pane fade show active" id="rooms-tab-pane" role="tabpanel" aria-labelledby="rooms-tab" tabindex="0">
                            <div id="roomListInModal">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading rooms...</p>
                                </div>
                            </div>
                            <div class="d-grid mt-3">
                                <button type="button" class="btn btn-outline-primary" id="refreshRoomsInModalBtn">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh Room List
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
                            <form id="create-room-form-in-modal">
                                <div class="mb-3">
                                    <label for="new-room-id-in-modal" class="form-label">Room ID</label>
                                    <input type="text" class="form-control" id="new-room-id-in-modal" placeholder="Unique identifier for the room (e.g., project-team)">
                                    <div class="form-text">Must be unique and contain only letters, numbers, and hyphens</div>
                                </div>
                                <div class="mb-3">
                                    <label for="new-room-name-in-modal" class="form-label">Room Name</label>
                                    <input type="text" class="form-control" id="new-room-name-in-modal" placeholder="Display name for the room (e.g., Project Team)">
                                </div>
                                <div class="mb-3">
                                    <label for="new-room-description-in-modal" class="form-label">Description (optional)</label>
                                    <textarea class="form-control" id="new-room-description-in-modal" rows="3" placeholder="Room description and purpose"></textarea>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary" id="create-room-btn-in-modal">
                                        <i class="bi bi-plus-circle me-1"></i>Create Room
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="active-tab-pane" role="tabpanel" aria-labelledby="active-tab" tabindex="0">
                            <div id="currentRoomInfo">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading room information...</p>
                                </div>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header">
                                    <i class="bi bi-people-fill me-1"></i>Room Members
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush" id="roomMembersList">
                                        <li class="list-group-item text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            <span class="ms-2">Loading members...</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Transfer Modal -->
    <div class="modal fade" id="fileTransferModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>File Transfer Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="fileTransferTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="send-file-tab" data-bs-toggle="tab" data-bs-target="#send-file-tab-pane" type="button" role="tab" aria-controls="send-file-tab-pane" aria-selected="true">
                                <i class="bi bi-upload me-1"></i>Send File
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="received-files-tab" data-bs-toggle="tab" data-bs-target="#received-files-tab-pane" type="button" role="tab" aria-controls="received-files-tab-pane" aria-selected="false">
                                <i class="bi bi-download me-1"></i>Received Files
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-security-tab" data-bs-toggle="tab" data-bs-target="#file-security-tab-pane" type="button" role="tab" aria-controls="file-security-tab-pane" aria-selected="false">
                                <i class="bi bi-shield-lock me-1"></i>Security Info
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="fileTransferTabContent">
                        <div class="tab-pane fade show active" id="send-file-tab-pane" role="tabpanel" aria-labelledby="send-file-tab" tabindex="0">
                            <form id="enhanced-file-form" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="enhancedFileInput" class="form-label">Select File to Send</label>
                                    <input class="form-control" type="file" id="enhancedFileInput" name="file">
                                    <div class="form-text">Maximum size: 50MB</div>
                                </div>
                                <div class="mb-3">
                                    <label for="fileDestinationRoom" class="form-label">Destination Room</label>
                                    <select class="form-select" id="fileDestinationRoom">
                                        <!-- Options will be loaded dynamically -->
                                        <option value="main">Main Room</option>
                                    </select>
                                </div>
                                <div class="progress mb-3">
                                    <div id="enhancedFileUploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                        style="width: 0%"></div>
                                </div>
                                <div id="enhancedUploadStatusMessage" class="alert alert-primary">
                                    Select a file and click "Send File" to upload
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="enhanced-upload-file-btn">
                                        <i class="bi bi-file-earmark-arrow-up me-1"></i>Send File
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="received-files-tab-pane" role="tabpanel" aria-labelledby="received-files-tab" tabindex="0">
                            <div class="mb-3">
                                <label for="fileRoomFilter" class="form-label">Filter by Room</label>
                                <select class="form-select" id="fileRoomFilter">
                                    <option value="all">All Rooms</option>
                                    <option value="main">Main Room</option>
                                    <!-- Other rooms will be added dynamically -->
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>Sender</th>
                                            <th>Size</th>
                                            <th>Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receivedFilesList">
                                        <tr>
                                            <td colspan="5" class="text-center">No files received yet</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="file-security-tab-pane" role="tabpanel" aria-labelledby="file-security-tab" tabindex="0">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-shield-lock me-1"></i>File Transfer Security
                                </div>
                                <div class="card-body">
                                    <p>Files are secured with end-to-end encryption using the Noise Protocol Framework:</p>
                                    <ul>
                                        <li><strong>Encryption:</strong> ChaCha20-Poly1305</li>
                                        <li><strong>Authentication:</strong> HMAC with SHA-256</li>
                                        <li><strong>Key Exchange:</strong> X25519 (Curve25519)</li>
                                        <li><strong>Forward Secrecy:</strong> Enabled</li>
                                    </ul>
                                    <p>Each file is encrypted before transmission and can only be decrypted by intended recipients.</p>

                                    <div class="alert alert-info mt-3">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        File metadata (name, size) is visible to room members, but file contents are encrypted.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fix for Room Management -->
    <script>
    // Initialize room management functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Fix for Create Room button
        const createRoomBtn = document.getElementById('create-room-btn');
        if (createRoomBtn) {
            createRoomBtn.addEventListener('click', function() {
                // Get form values
                const roomId = document.getElementById('new-room-id').value.trim();
                const roomName = document.getElementById('new-room-name').value.trim();
                const description = document.getElementById('new-room-description').value.trim();
                
                if (!roomId || !roomName) {
                    alert('Room ID and name are required');
                    return;
                }
                
                // Show loading state
                createRoomBtn.disabled = true;
                createRoomBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
                
                // Send the request
                fetch('/create_room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_id: roomId,
                        room_name: roomName,
                        description: description
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    createRoomBtn.disabled = false;
                    createRoomBtn.textContent = 'Create Room';
                    
                    if (data.success) {
                        // Hide modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createRoomModal'));
                        modal.hide();
                        
                        // Show success message
                        showAlert('Room created successfully', 'success');
                        
                        // Refresh room list
                        refreshRoomList();
                        
                        // Clear form
                        document.getElementById('new-room-id').value = '';
                        document.getElementById('new-room-name').value = '';
                        document.getElementById('new-room-description').value = '';
                        
                        // Join the new room
                        joinRoom(roomId);
                    } else {
                        showAlert(data.message || 'Failed to create room', 'danger');
                    }
                })
                .catch(error => {
                    // Reset button state
                    createRoomBtn.disabled = false;
                    createRoomBtn.textContent = 'Create Room';
                    
                    console.error('Error:', error);
                    showAlert('Failed to create room', 'danger');
                });
            });
        }
        
        // Fix for Leave buttons in room list
        document.addEventListener('click', function(event) {
            // Check if the clicked element is a Leave button
            if (event.target.classList.contains('leave-room-btn') || 
                (event.target.tagName === 'BUTTON' && event.target.textContent.trim() === 'Leave')) {
                event.preventDefault();
                
                // Get room ID from the button's data attribute or from the parent container
                let roomId;
                if (event.target.hasAttribute('data-room-id')) {
                    roomId = event.target.getAttribute('data-room-id');
                } else {
                    // Try to find the room ID from the surrounding elements
                    const roomSection = event.target.closest('.room-item') || event.target.closest('section');
                    if (roomSection) {
                        const idElement = roomSection.querySelector('*:contains("ID:")');
                        if (idElement) {
                            // Extract the ID from text like "ID: main"
                            const idText = idElement.textContent;
                            const match = idText.match(/ID:\s*(\S+)/);
                            if (match && match[1]) {
                                roomId = match[1];
                            }
                        }
                    }
                }
                
                // If we've found a room ID, call the leaveRoom function
                if (roomId) {
                    leaveRoom(roomId);
                } else {
                    console.error('Could not determine room ID for leave button');
                    showAlert('Could not determine which room to leave', 'danger');
                }
            }
        });
        
        // Fix for Refresh Rooms button
        const refreshBtn = document.querySelector('#refresh-rooms-btn, button:contains("Refresh")');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                refreshRoomList();
            });
        }
        
        // Initialize room management when the modal is shown
        const roomListModal = document.getElementById('roomListModal');
        if (roomListModal) {
            roomListModal.addEventListener('shown.bs.modal', function() {
                refreshRoomList();
            });
        }
    });

    // Implement leaveRoom function
    function leaveRoom(roomId) {
        if (!roomId) {
            console.error('No room ID provided to leaveRoom function');
            return;
        }
        
        // Show loading state on button if found
        const leaveBtn = document.querySelector(`button[data-room-id="${roomId}"]`) || 
                        document.querySelector('button:contains("Leave")');
        
        if (leaveBtn) {
            const originalText = leaveBtn.textContent;
            leaveBtn.disabled = true;
            leaveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Leaving...';
        }
        
        fetch('/leave_room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                room_id: roomId
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Reset button state if found
            if (leaveBtn) {
                leaveBtn.disabled = false;
                leaveBtn.textContent = 'Leave';
            }
            
            if (data.success) {
                // Show success message
                showAlert(data.message || 'Left room successfully', 'success');
                
                // Reset active room to Main Room
                const activeRoomEl = document.getElementById('active-room');
                if (activeRoomEl) {
                    activeRoomEl.textContent = 'Main Room';
                }
                
                // Close the modal if it's open
                const roomListModal = bootstrap.Modal.getInstance(document.getElementById('roomListModal'));
                if (roomListModal) {
                    roomListModal.hide();
                }
                
                // Refresh room list
                refreshRoomList();
                
                // Clear URL parameter
                const url = new URL(window.location);
                url.searchParams.delete('room');
                window.history.pushState({}, '', url);
                
                // Clear chat messages and add system message
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.innerHTML += `<div class="system-message">You left the room</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Auto-join Main Room
                joinRoom('main');
            } else {
                showAlert(data.message || 'Failed to leave room', 'danger');
            }
        })
        .catch(error => {
            // Reset button state if found
            if (leaveBtn) {
                leaveBtn.disabled = false;
                leaveBtn.textContent = 'Leave';
            }
            
            console.error('Error:', error);
            showAlert('Network error, please try again', 'danger');
        });
    }

    // Implement refreshRoomList function
    function refreshRoomList() {
        const roomList = document.getElementById('room-list');
        if (!roomList) {
            console.error('Room list element not found');
            return;
        }
        
        // Show loading spinner
        roomList.innerHTML = '<div class="text-center my-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading rooms...</p></div>';
        
        // Fetch rooms from server
        fetch('/rooms')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderRoomList(data.rooms || []);
                } else {
                    roomList.innerHTML = `<div class="alert alert-danger">Failed to load rooms: ${data.message || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching rooms:', error);
                roomList.innerHTML = `<div class="alert alert-danger">Error loading rooms: ${error.message}</div>`;
            });
    }

    // Render the list of rooms
    function renderRoomList(rooms) {
        const roomList = document.getElementById('room-list');
        if (!roomList) return;
        
        if (!rooms || rooms.length === 0) {
            roomList.innerHTML = '<div class="text-center text-muted my-3">No rooms available</div>';
            return;
        }
        
        // Get current active room
        const activeRoomEl = document.getElementById('active-room');
        const activeRoom = activeRoomEl ? activeRoomEl.textContent.trim() : 'Main Room';
        
        let html = '';
        
        // Process each room
        rooms.forEach(room => {
            const isActive = (room.name === activeRoom) || (room.id === activeRoom) || 
                            (activeRoom === 'Main Room' && room.id === 'main');
            
            const buttonClass = isActive ? 'btn-outline-danger' : 'btn-outline-primary';
            const buttonText = isActive ? 'Leave' : 'Join';
            const actionClass = isActive ? 'leave-room-btn' : 'join-room-btn';
            
            html += `
                <div class="room-item p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold">${escapeHtml(room.name)}</div>
                            <div class="small text-muted">ID: ${escapeHtml(room.id)}</div>
                            ${room.description ? `<div class="small">${escapeHtml(room.description)}</div>` : ''}
                            <div class="small">Members: ${room.member_count || 0}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm ${buttonClass} ${actionClass}" 
                                    data-room-id="${escapeHtml(room.id)}">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        roomList.innerHTML = html;
        
        // Add event listeners to the newly created buttons
        roomList.querySelectorAll('.join-room-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const roomId = this.getAttribute('data-room-id');
                joinRoom(roomId);
            });
        });
        
        roomList.querySelectorAll('.leave-room-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const roomId = this.getAttribute('data-room-id');
                leaveRoom(roomId);
            });
        });
    }

    // Implement joinRoom function
    function joinRoom(roomId) {
        if (!roomId) {
            console.error('No room ID provided to joinRoom function');
            return;
        }
        
        // Show loading state on button if found
        const joinBtn = document.querySelector(`button[data-room-id="${roomId}"]`);
        if (joinBtn) {
            const originalText = joinBtn.textContent;
            joinBtn.disabled = true;
            joinBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Joining...';
        }
        
        fetch('/join_room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                room_id: roomId
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Reset button state if found
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join';
            }
            
            if (data.success) {
                // Update active room
                const activeRoomEl = document.getElementById('active-room');
                if (activeRoomEl) {
                    activeRoomEl.textContent = data.room.name || roomId;
                }
                
                // Show success message
                showAlert(`Joined room ${data.room.name || roomId}`, 'success');
                
                // Close modal if open
                const roomListModal = bootstrap.Modal.getInstance(document.getElementById('roomListModal'));
                if (roomListModal) {
                    roomListModal.hide();
                }
                
                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('room', roomId);
                window.history.pushState({}, '', url);
                
                // Add system message to chat
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.innerHTML += `<div class="system-message">You joined ${data.room.name || roomId}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } else {
                showAlert(data.message || 'Failed to join room', 'danger');
            }
        })
        .catch(error => {
            // Reset button state if found
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join';
            }
            
            console.error('Error:', error);
            showAlert('Network error, please try again', 'danger');
        });
    }
    
    // Enhanced sendMessage function to support rooms
    function sendMessage() {
        const message = $('#message-input').val().trim();
        if (!message) return;
        
        // Clear input immediately
        $('#message-input').val('');
        
        // Get the active room from UI
        const activeRoomElement = document.getElementById('active-room');
        const activeRoom = activeRoomElement ? activeRoomElement.textContent.trim() : 'Main Room';
        
        // Extract room ID from URL if available
        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        
        // Determine which room to send to
        const roomId = roomParam || (activeRoom === 'Main Room' ? 'main' : activeRoom);
        
        $.ajax({
            url: '/send',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                message: message,
                room_id: roomId
            }),
            success: function(response) {
                if (!response.success) {
                    showAlert(response.message || 'Failed to send message', 'danger');
                    // Return the message to the input box
                    $('#message-input').val(message);
                }
            },
            error: function() {
                showAlert('Failed to send message', 'danger');
                $('#message-input').val(message);
            }
        });
    }

    // Helper function to show alerts
    function showAlert(message, type = 'info') {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.role = 'alert';
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Find a good place to show the alert
        const container = document.querySelector('.container-fluid .row:first-child');
        if (container) {
            container.prepend(alertContainer);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertContainer.classList.remove('show');
                setTimeout(() => alertContainer.remove(), 150);
            }, 5000);
        } else {
            // Fallback to inserting at the top of the body
            document.body.prepend(alertContainer);
        }
    }

    // Helper function to escape HTML
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // Override the message form submit handler to use our enhanced sendMessage function
    $(document).ready(function() {
        $('#message-form').on('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    });
    </script>
</body>
</html>